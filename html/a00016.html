<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.4"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>core_arena: Internal functions.</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">core_arena<span id="projectnumber">&#160;859f7ea</span>
   </div>
   <div id="projectbrief">An arena allocater that uses core memory aside malloc.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.4 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle"><div class="title">Internal functions.</div></div>
</div><!--header-->
<div class="contents">

<p>Internal allocation functions for allocating computer memory.  
<a href="#details">More...</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="func-members" name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:ga5289ecd9e87b60489a92476dff6db1f4"><td class="memItemLeft" align="right" valign="top">static <a class="el" href="a00012.html#gaa3c04ba804275765a4e49c9872d46a25">Arena</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00016.html#ga5289ecd9e87b60489a92476dff6db1f4">_arena_init</a> (size_t n, size_t chunk_sz)</td></tr>
<tr class="memdesc:ga5289ecd9e87b60489a92476dff6db1f4"><td class="mdescLeft">&#160;</td><td class="mdescRight">Initializes an arena and configures it with the effective chunk_size, and allocates the memory, with malloc(), it also accounts for memory allocated if logging is turned on.  <a href="a00016.html#ga5289ecd9e87b60489a92476dff6db1f4">More...</a><br /></td></tr>
<tr class="separator:ga5289ecd9e87b60489a92476dff6db1f4"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gad01532f3342fe036d695423b35bed788"><td class="memItemLeft" align="right" valign="top">static void *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00016.html#gad01532f3342fe036d695423b35bed788">_alloc</a> (<a class="el" href="a00012.html#gaa3c04ba804275765a4e49c9872d46a25">Arena</a> **p, size_t mem_sz, size_t n)</td></tr>
<tr class="memdesc:gad01532f3342fe036d695423b35bed788"><td class="mdescLeft">&#160;</td><td class="mdescRight">Allocates memory from an arena a new arena if necessary for delivering the request.  <a href="a00016.html#gad01532f3342fe036d695423b35bed788">More...</a><br /></td></tr>
<tr class="separator:gad01532f3342fe036d695423b35bed788"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="var-members" name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:gaed14729b276ffd787a796f3930aee5a0"><td class="memItemLeft" align="right" valign="top">static const char *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00016.html#gaed14729b276ffd787a796f3930aee5a0">alloc_emsg</a> = &quot;%s: <a class="el" href="a00024.html">arena</a>[%u] The chunk_sz requested is to small: %d\n&quot;</td></tr>
<tr class="separator:gaed14729b276ffd787a796f3930aee5a0"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga3429f895d1651d326f1f51b33103cf93"><td class="memItemLeft" align="right" valign="top">static const char *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00016.html#ga3429f895d1651d326f1f51b33103cf93">alloc_emsg2</a></td></tr>
<tr class="separator:ga3429f895d1651d326f1f51b33103cf93"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gaa9a9dfd169f61203f384a34ec9134241"><td class="memItemLeft" align="right" valign="top">static const char *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00016.html#gaa9a9dfd169f61203f384a34ec9134241">alloc_emsg3</a></td></tr>
<tr class="separator:gaa9a9dfd169f61203f384a34ec9134241"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<p >Internal allocation functions for allocating computer memory. </p>
<h2 class="groupheader">Function Documentation</h2>
<a id="gad01532f3342fe036d695423b35bed788" name="gad01532f3342fe036d695423b35bed788"></a>
<h2 class="memtitle"><span class="permalink"><a href="#gad01532f3342fe036d695423b35bed788">&#9670;&nbsp;</a></span>_alloc()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void * _alloc </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="a00012.html#gaa3c04ba804275765a4e49c9872d46a25">Arena</a> **&#160;</td>
          <td class="paramname"><em>p</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">size_t&#160;</td>
          <td class="paramname"><em>mem_sz</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">size_t&#160;</td>
          <td class="paramname"><em>n</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Allocates memory from an arena a new arena if necessary for delivering the request. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">**p</td><td>The arena to request memory from, can change if needs new arena. </td></tr>
    <tr><td class="paramname">mem_sz</td><td>The amount of memory requested. </td></tr>
    <tr><td class="paramname">n</td><td>The arena number so we can log allocations to it, and identify configured chunk_sz. @detail This is basically Hanson's work. This scheme is like it is so that it can work after a deallocation of the areas too, reusing the previously not freed memory. Algorithm taken from Hanson p. 3 where it is described, but with padding method from Wellons, in addition I have added a "fail-safe" for when the ask for memory is larger than then chunk_sz the arena is currently configured for, so that it will then as a "one-off" case allocate a sufficiently large block. 23-12-27: Now this is basically u/skeetos work for I have followed most of his recommendations in hardening the function. </td></tr>
  </table>
  </dd>
</dl>
<dl class="todo"><dt><b><a class="el" href="a00011.html#_todo000005">Todo:</a></b></dt><dd>, really, why don't we add the chunk_sz. </dd></dl>
<dl class="todo"><dt><b><a class="el" href="a00011.html#_todo000006">Todo:</a></b></dt><dd>function. </dd></dl>

<p class="definition">Definition at line <a class="el" href="a00008_source.html#l00500">500</a> of file <a class="el" href="a00008_source.html">core_arena.c</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">  501</span>{</div>
<div class="line"><span class="lineno">  502</span>   <span class="comment">// First reject anything nonsensical or excessively large .</span></div>
<div class="line"><span class="lineno">  503</span>    <span class="keywordflow">if</span> ( mem_sz == 0 || mem_sz &gt; PTRDIFF_MAX ) {</div>
<div class="line"><span class="lineno">  504</span>        <span class="keywordflow">return</span> NULL; <span class="comment">// request impossibly large (out of memory)</span></div>
<div class="line"><span class="lineno">  505</span>    }</div>
<div class="line"><span class="lineno">  506</span>   <span class="comment">// Convert to signed so that it does not implicitly cast expression </span></div>
<div class="line"><span class="lineno">  507</span>   <span class="comment">// using it to size_t later. After this mem_sz is no longer needed.</span></div>
<div class="line"><span class="lineno">  508</span>    ptrdiff_t mem_pd = mem_sz;</div>
<div class="line"><span class="lineno">  509</span>   <span class="comment">// Padding will be a small non-negative number. It is always safe</span></div>
<div class="line"><span class="lineno">  510</span>   <span class="comment">// to subtract from a size, as the result will at worst be a small</span></div>
<div class="line"><span class="lineno">  511</span>   <span class="comment">// negative number.</span></div>
<div class="line"><span class="lineno">  512</span>    ptrdiff_t padding = -mem_pd &amp; ( <a class="code hl_define" href="a00005.html#a545f62359724046a1928aba877fcf1f3">MAX_ALIGN</a> - 1 );</div>
<div class="line"><span class="lineno">  513</span> </div>
<div class="line"><span class="lineno">  514</span>    <span class="comment">// Size calculations differ here from _arena_init</span></div>
<div class="line"><span class="lineno">  515</span>    <span class="comment">// We want a chunk of memory from a l</span></div>
<div class="line"><span class="lineno">  516</span> </div>
<div class="line"><span class="lineno">  517</span> </div>
<div class="line"><span class="lineno">  518</span>    <a class="code hl_struct" href="a00024.html">Arena</a> *ap;</div>
<div class="line"><span class="lineno">  519</span>    <span class="keywordflow">for</span> ( ap = *p;; *p = ap ) {</div>
<div class="line"><span class="lineno">  520</span>       <span class="comment">// Work using a size, not with pointer arithmetic.</span></div>
<div class="line"><span class="lineno">  521</span>        ptrdiff_t available = ap-&gt;<a class="code hl_variable" href="a00024.html#ae6dcf9e039a3695a6fa348e704b5ab67">end</a> - ap-&gt;begin; </div>
<div class="line"><span class="lineno">  522</span>        <span class="comment">// assert(available &gt;= 0 );</span></div>
<div class="line"><span class="lineno">  523</span> </div>
<div class="line"><span class="lineno">  524</span>       <span class="comment">// Per the note, this subtraction is safe. Both operands are</span></div>
<div class="line"><span class="lineno">  525</span>       <span class="comment">// signed, so no surprise promotions turning a small negative</span></div>
<div class="line"><span class="lineno">  526</span>       <span class="comment">// into large positive (i.e. size_t).</span></div>
<div class="line"><span class="lineno">  527</span>        <span class="keywordflow">if</span> ( mem_pd &gt; available - padding ) {</div>
<div class="line"><span class="lineno">  528</span>            <span class="keywordflow">if</span> ( ap-&gt;next ) {</div>
<div class="line"><span class="lineno">  529</span>                ap = ap-&gt;next;</div>
<div class="line"><span class="lineno">  530</span>                ap-&gt;begin = ( <span class="keywordtype">char</span> * ) ap + <a class="code hl_variable" href="a00012.html#ga2db21cb8e8ff4fdaa008145917a13c01">ARENA_HEADER_SIZE</a>; <span class="comment">// reset!</span></div>
<div class="line"><span class="lineno">  531</span>                <span class="comment">// ap-&gt;end is never touched!</span></div>
<div class="line"><span class="lineno">  532</span>                <span class="keywordflow">continue</span>; <span class="comment">// keep looking</span></div>
<div class="line"><span class="lineno">  533</span> </div>
<div class="line"><span class="lineno">  534</span>            } <span class="keywordflow">else</span> { <span class="comment">// End of the list, allocate a new chunk.</span></div>
<div class="line"><span class="lineno">  535</span>               <span class="comment">// It is *not* yet safe to add header_size to mem_pd,</span></div>
<div class="line"><span class="lineno">  536</span>               <span class="comment">// so subtract from the other side.¸</span></div>
<div class="line"><span class="lineno">  537</span>                <span class="keywordflow">if</span> ( mem_pd &gt; (PTRDIFF_MAX - <a class="code hl_variable" href="a00012.html#ga2db21cb8e8ff4fdaa008145917a13c01">ARENA_HEADER_SIZE</a> - padding) ) {</div>
<div class="line"><span class="lineno">  538</span>                    <span class="keywordflow">return</span> NULL; <span class="comment">// request too large for metadata</span></div>
<div class="line"><span class="lineno">  539</span>                }</div>
<div class="line"><span class="lineno">  540</span>               <span class="comment">// At this point we know header_size+mem_pd+padding is</span></div>
<div class="line"><span class="lineno">  541</span>               <span class="comment">// safe to compute.</span></div>
<div class="line"><span class="lineno">  542</span> </div>
<div class="line"><span class="lineno">  543</span>               <span class="comment">// Note: chunk_sz does not require any alignment padding,</span></div>
<div class="line"><span class="lineno">  544</span>               <span class="comment">// accounted for.</span></div>
<div class="line"><span class="lineno">  545</span>                ptrdiff_t real_size = <a class="code hl_define" href="a00012.html#gafa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>( ( mem_pd + padding + <a class="code hl_variable" href="a00012.html#ga2db21cb8e8ff4fdaa008145917a13c01">ARENA_HEADER_SIZE</a> ), ( ptrdiff_t ) <a class="code hl_variable" href="a00012.html#ga78a93982f8ff9e5611e5a7cd5358864f">first</a>[n].chunk_sz );</div>
<div class="line"><span class="lineno">  546</span> </div>
<div class="line"><span class="lineno">  547</span> </div>
<div class="line"><span class="lineno">  548</span>                <span class="keywordflow">if</span> ( real_size &gt; (ssize_t)<a class="code hl_variable" href="a00008.html#a8947d7bceb80934a62e9b068cdc31590">ARENAS_MAX_ALLOC</a> ) {</div>
<div class="line"><span class="lineno">  549</span>                    fprintf( stderr, <a class="code hl_variable" href="a00016.html#ga3429f895d1651d326f1f51b33103cf93">alloc_emsg2</a>,<span class="stringliteral">&quot;_alloc&quot;</span>,n,real_size, <a class="code hl_variable" href="a00008.html#a8947d7bceb80934a62e9b068cdc31590">ARENAS_MAX_ALLOC</a> );</div>
<div class="line"><span class="lineno">  550</span>                    exit(EXIT_FAILURE) ;</div>
<div class="line"><span class="lineno">  551</span>                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <a class="code hl_variable" href="a00015.html#ga1df927675e1c3b3474a43682105fe225">tot_mem_usage</a> &gt; <a class="code hl_variable" href="a00008.html#a8947d7bceb80934a62e9b068cdc31590">ARENAS_MAX_ALLOC</a> - real_size ) {</div>
<div class="line"><span class="lineno">  552</span>                    fprintf( stderr, <a class="code hl_variable" href="a00016.html#gaa9a9dfd169f61203f384a34ec9134241">alloc_emsg3</a>, <span class="stringliteral">&quot;_alloc&quot;</span>,n,real_size, <a class="code hl_variable" href="a00008.html#a8947d7bceb80934a62e9b068cdc31590">ARENAS_MAX_ALLOC</a> );</div>
<div class="line"><span class="lineno">  553</span>                    exit(EXIT_FAILURE) ;</div>
<div class="line"><span class="lineno">  554</span>                }</div>
<div class="line"><span class="lineno">  555</span> </div>
<div class="line"><span class="lineno">  556</span>                ap = ap-&gt;next = malloc( (<span class="keywordtype">size_t</span>)real_size );</div>
<div class="line"><span class="lineno">  557</span>                <span class="keywordflow">if</span> ( !ap ) {</div>
<div class="line"><span class="lineno">  558</span>                    <span class="keywordflow">return</span> NULL; <span class="comment">// OOM (can happen on Linux with huge mem_sz!)</span></div>
<div class="line"><span class="lineno">  559</span>                }</div>
<div class="line"><span class="lineno">  560</span>                <a class="code hl_variable" href="a00015.html#ga1df927675e1c3b3474a43682105fe225">tot_mem_usage</a> += real_size ; <span class="comment">// updates total allocated.</span></div>
<div class="line"><span class="lineno">  561</span> </div>
<div class="line"><span class="lineno">  562</span><span class="preprocessor">#ifndef CORE_ARENA_NO_LOGGING</span></div>
<div class="line"><span class="lineno">  563</span>                <span class="keywordflow">if</span> (<a class="code hl_variable" href="a00015.html#gab1eaae997e785328330ae4bbf7cf3d0f">core_arena_log_level</a> &gt;= <a class="code hl_define" href="a00015.html#ga55710d867b81d742af6057b89017ba7b">LOG_CHUNK_MALLOCS</a> ) {</div>
<div class="line"><span class="lineno">  564</span>                    <span class="keywordflow">if</span> ( real_size &lt; <a class="code hl_variable" href="a00012.html#ga7523792ea5e325a82e80efcea1ef3791">c128K</a> ) {</div>
<div class="line"><span class="lineno">  565</span>                        <a class="code hl_variable" href="a00015.html#ga7f0e6ee371f41cbb641b2a74ffcc799e">arenas_mem_malloced</a>[n] += real_size ;</div>
<div class="line"><span class="lineno">  566</span>                        <a class="code hl_variable" href="a00015.html#ga43a17f892ca9f175f4534e44ebc76fc1">arenas_mem_malloced_count</a>[n] += 1 ;</div>
<div class="line"><span class="lineno">  567</span>                    } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno">  568</span>                        <a class="code hl_variable" href="a00015.html#ga28ecc87bc4223b8f9c40e9bd2cf7ed32">arenas_mem_mmapped</a>[n] += real_size ;</div>
<div class="line"><span class="lineno">  569</span>                        <a class="code hl_variable" href="a00015.html#ga39626941a835902709e5be48ab078b87">arenas_mem_mmapped_count</a>[n] += 1 ;</div>
<div class="line"><span class="lineno">  570</span>                    }</div>
<div class="line"><span class="lineno">  571</span>                    <span class="keywordflow">if</span> ((<span class="keywordtype">size_t</span>)real_size &gt; <a class="code hl_variable" href="a00015.html#ga9fd032f6aaa6a58f211f912303012499">arenas_max_chunk_size</a>[n] ) {</div>
<div class="line"><span class="lineno">  572</span>                        <a class="code hl_variable" href="a00015.html#ga9fd032f6aaa6a58f211f912303012499">arenas_max_chunk_size</a>[n] = real_size ;</div>
<div class="line"><span class="lineno">  573</span>                    }</div>
<div class="line"><span class="lineno">  574</span>                }</div>
<div class="line"><span class="lineno">  575</span><span class="preprocessor">#endif</span></div>
<div class="line"><span class="lineno">  576</span>                ap-&gt;next = NULL;</div>
<div class="line"><span class="lineno">  577</span>                *p = ap ; <span class="comment">// BUGFIX we are breaking out, and won&#39;t update in for loop.</span></div>
<div class="line"><span class="lineno">  578</span>                <span class="keywordflow">if</span> ( (<span class="keywordtype">size_t</span>)real_size &gt;  <a class="code hl_variable" href="a00012.html#ga78a93982f8ff9e5611e5a7cd5358864f">first</a>[n].chunk_sz ) {</div>
<div class="line"><span class="lineno">  580</span>                    ap-&gt;<a class="code hl_variable" href="a00024.html#a3f9b268a1aaf3b8a2823433aec29faf2">chunk_sz</a> = (size_t) (real_size - <a class="code hl_variable" href="a00012.html#ga2db21cb8e8ff4fdaa008145917a13c01">ARENA_HEADER_SIZE</a>) ;</div>
<div class="line"><span class="lineno">  581</span>                } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno">  582</span>                    ap-&gt;chunk_sz = <a class="code hl_variable" href="a00012.html#ga78a93982f8ff9e5611e5a7cd5358864f">first</a>[n].<a class="code hl_variable" href="a00024.html#a3f9b268a1aaf3b8a2823433aec29faf2">chunk_sz</a>;</div>
<div class="line"><span class="lineno">  583</span>                }</div>
<div class="line"><span class="lineno">  584</span>                ap-&gt;begin = ( <span class="keywordtype">char</span> * ) ap + <a class="code hl_variable" href="a00012.html#ga2db21cb8e8ff4fdaa008145917a13c01">ARENA_HEADER_SIZE</a>;</div>
<div class="line"><span class="lineno">  585</span>                ap-&gt;end = ap-&gt;begin + ap-&gt;chunk_sz;</div>
<div class="line"><span class="lineno">  586</span>                <span class="keywordflow">break</span>; <span class="comment">// use this arena</span></div>
<div class="line"><span class="lineno">  587</span>            }</div>
<div class="line"><span class="lineno">  588</span>        } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno">  589</span>            <span class="keywordflow">break</span>; <span class="comment">// found space</span></div>
<div class="line"><span class="lineno">  590</span>        }</div>
<div class="line"><span class="lineno">  591</span>    }</div>
<div class="line"><span class="lineno">  592</span> </div>
<div class="line"><span class="lineno">  593</span>    <span class="keywordtype">void</span> *ptr = ap-&gt;begin;</div>
<div class="line"><span class="lineno">  594</span>    ap-&gt;begin += mem_pd + padding; <span class="comment">// checks passed, so addition is safe</span></div>
<div class="line"><span class="lineno">  595</span>    <span class="comment">// Starting point for next memory allocation.</span></div>
<div class="line"><span class="lineno">  596</span> </div>
<div class="line"><span class="lineno">  597</span><span class="preprocessor">#ifndef CORE_ARENA_NO_LOGGING</span></div>
<div class="line"><span class="lineno">  598</span>    <span class="keywordflow">if</span> (<a class="code hl_variable" href="a00015.html#gab1eaae997e785328330ae4bbf7cf3d0f">core_arena_log_level</a> &gt;= <a class="code hl_define" href="a00015.html#ga1916d6f5e5c7448b09095b19899b482c">FULL_ARENA_LOGGING</a> ) {</div>
<div class="line"><span class="lineno">  600</span>        <a class="code hl_variable" href="a00015.html#ga5acb1eb15a723f350bda9bb29734b186">arenas_mem_served_count</a>[n] += 1 ;</div>
<div class="line"><span class="lineno">  601</span>        <a class="code hl_variable" href="a00015.html#ga49ca11b978773e49b190c6f977122988">arenas_mem_served</a>[n] += mem_pd ;</div>
<div class="line"><span class="lineno">  602</span> </div>
<div class="line"><span class="lineno">  603</span>        <span class="keywordflow">if</span> ( mem_pd &gt; (ptrdiff_t) <a class="code hl_variable" href="a00015.html#gad9e78bad28be8f331191b4603736f033">arenas_max_mem_request</a>[n] ) {</div>
<div class="line"><span class="lineno">  604</span>            <a class="code hl_variable" href="a00015.html#gad9e78bad28be8f331191b4603736f033">arenas_max_mem_request</a>[n] = mem_pd ;</div>
<div class="line"><span class="lineno">  605</span>        }</div>
<div class="line"><span class="lineno">  606</span>        <span class="keywordflow">if</span> ( (<span class="keywordtype">size_t</span>) mem_pd &lt; <a class="code hl_variable" href="a00015.html#ga217368e99341605e4ee440c4c7793204">arenas_min_mem_request</a>[n] ) {</div>
<div class="line"><span class="lineno">  607</span>            <a class="code hl_variable" href="a00015.html#ga217368e99341605e4ee440c4c7793204">arenas_min_mem_request</a>[n] = mem_pd ;</div>
<div class="line"><span class="lineno">  608</span>        }</div>
<div class="line"><span class="lineno">  609</span>        <a class="code hl_variable" href="a00015.html#ga93bdbec87512dff3ba3a0c59de956149">arenas_avg_mem_request</a>[n] = <a class="code hl_variable" href="a00015.html#ga49ca11b978773e49b190c6f977122988">arenas_mem_served</a>[n] / <a class="code hl_variable" href="a00015.html#ga5acb1eb15a723f350bda9bb29734b186">arenas_mem_served_count</a>[n] ;</div>
<div class="line"><span class="lineno">  610</span> </div>
<div class="line"><span class="lineno">  611</span>    }</div>
<div class="line"><span class="lineno">  612</span> </div>
<div class="line"><span class="lineno">  613</span><span class="preprocessor">#endif</span></div>
<div class="line"><span class="lineno">  614</span>   <span class="comment">// Note: I strongly recommend zero-initialization by default. It</span></div>
<div class="line"><span class="lineno">  615</span>   <span class="comment">// makes for clearer, shorter, and more robust programs. If it&#39;s</span></div>
<div class="line"><span class="lineno">  616</span>   <span class="comment">// too slow in some cases, add an opt-out flag.</span></div>
<div class="line"><span class="lineno">  617</span> </div>
<div class="line"><span class="lineno">  618</span>   <span class="comment">// Zeroing out the last byte and the padding</span></div>
<div class="line"><span class="lineno">  619</span>   <span class="comment">// will implement an `arena_calloc` that zeroes out all returned memory,</span></div>
<div class="line"><span class="lineno">  620</span>   <span class="comment">// to follow the usual convention, to get it done! makes swapping methods</span></div>
<div class="line"><span class="lineno">  621</span>   <span class="comment">// easier.</span></div>
<div class="line"><span class="lineno">  622</span>    <span class="keywordflow">for</span> ( <span class="keywordtype">char</span> *zptr = ap-&gt;begin - ( padding + 1 ); zptr &lt; ap-&gt;begin; zptr++ ) {</div>
<div class="line"><span class="lineno">  623</span>        *zptr = <span class="charliteral">&#39;\0&#39;</span>;</div>
<div class="line"><span class="lineno">  624</span>    }</div>
<div class="line"><span class="lineno">  625</span>    <span class="comment">// MAX_ALIGN added by caller _arena_alloc.</span></div>
<div class="line"><span class="lineno">  626</span>    <span class="keywordflow">return</span> ptr;</div>
<div class="line"><span class="lineno">  627</span>   <span class="comment">// return memset(ptr, 0, mem_pd);</span></div>
<div class="line"><span class="lineno">  628</span>}</div>
<div class="ttc" id="aa00005_html_a545f62359724046a1928aba877fcf1f3"><div class="ttname"><a href="a00005.html#a545f62359724046a1928aba877fcf1f3">MAX_ALIGN</a></div><div class="ttdeci">#define MAX_ALIGN</div><div class="ttdoc">It needs to be 16 since malloc needs to be able to serve memory that can hold any object,...</div><div class="ttdef"><b>Definition:</b> <a href="a00005_source.html#l00049">core_arena.h:49</a></div></div>
<div class="ttc" id="aa00008_html_a8947d7bceb80934a62e9b068cdc31590"><div class="ttname"><a href="a00008.html#a8947d7bceb80934a62e9b068cdc31590">ARENAS_MAX_ALLOC</a></div><div class="ttdeci">size_t ARENAS_MAX_ALLOC</div><div class="ttdef"><b>Definition:</b> <a href="a00008_source.html#l00183">core_arena.c:183</a></div></div>
<div class="ttc" id="aa00012_html_ga2db21cb8e8ff4fdaa008145917a13c01"><div class="ttname"><a href="a00012.html#ga2db21cb8e8ff4fdaa008145917a13c01">ARENA_HEADER_SIZE</a></div><div class="ttdeci">const ptrdiff_t ARENA_HEADER_SIZE</div><div class="ttdoc">Arena Header Size.</div><div class="ttdef"><b>Definition:</b> <a href="a00008_source.html#l00055">core_arena.c:55</a></div></div>
<div class="ttc" id="aa00012_html_ga7523792ea5e325a82e80efcea1ef3791"><div class="ttname"><a href="a00012.html#ga7523792ea5e325a82e80efcea1ef3791">c128K</a></div><div class="ttdeci">static const ptrdiff_t c128K</div><div class="ttdoc">constant for 128K, which is max malloc can allocate from core.</div><div class="ttdef"><b>Definition:</b> <a href="a00008_source.html#l00033">core_arena.c:33</a></div></div>
<div class="ttc" id="aa00012_html_ga78a93982f8ff9e5611e5a7cd5358864f"><div class="ttname"><a href="a00012.html#ga78a93982f8ff9e5611e5a7cd5358864f">first</a></div><div class="ttdeci">static Arena * first</div><div class="ttdoc">A head pointer to the first arena.</div><div class="ttdef"><b>Definition:</b> <a href="a00008_source.html#l00048">core_arena.c:48</a></div></div>
<div class="ttc" id="aa00012_html_gafa99ec4acc4ecb2dc3c2d05da15d0e3f"><div class="ttname"><a href="a00012.html#gafa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a></div><div class="ttdeci">#define MAX(a, b)</div><div class="ttdoc">Simple MAX macro, since no sideeffects.</div><div class="ttdef"><b>Definition:</b> <a href="a00008_source.html#l00058">core_arena.c:58</a></div></div>
<div class="ttc" id="aa00015_html_ga1916d6f5e5c7448b09095b19899b482c"><div class="ttname"><a href="a00015.html#ga1916d6f5e5c7448b09095b19899b482c">FULL_ARENA_LOGGING</a></div><div class="ttdeci">#define FULL_ARENA_LOGGING</div><div class="ttdoc">Constant for logging bothh allocations of memory for the arenas, and the allocations.</div><div class="ttdef"><b>Definition:</b> <a href="a00008_source.html#l00261">core_arena.c:259</a></div></div>
<div class="ttc" id="aa00015_html_ga1df927675e1c3b3474a43682105fe225"><div class="ttname"><a href="a00015.html#ga1df927675e1c3b3474a43682105fe225">tot_mem_usage</a></div><div class="ttdeci">static size_t tot_mem_usage</div><div class="ttdef"><b>Definition:</b> <a href="a00008_source.html#l00279">core_arena.c:279</a></div></div>
<div class="ttc" id="aa00015_html_ga217368e99341605e4ee440c4c7793204"><div class="ttname"><a href="a00015.html#ga217368e99341605e4ee440c4c7793204">arenas_min_mem_request</a></div><div class="ttdeci">static size_t * arenas_min_mem_request</div><div class="ttdoc">‍For logging largest memory request for each arena.</div><div class="ttdef"><b>Definition:</b> <a href="a00008_source.html#l00290">core_arena.c:290</a></div></div>
<div class="ttc" id="aa00015_html_ga28ecc87bc4223b8f9c40e9bd2cf7ed32"><div class="ttname"><a href="a00015.html#ga28ecc87bc4223b8f9c40e9bd2cf7ed32">arenas_mem_mmapped</a></div><div class="ttdeci">static size_t * arenas_mem_mmapped</div><div class="ttdoc">&gt;Number of allocations of ram per arenas.</div><div class="ttdef"><b>Definition:</b> <a href="a00008_source.html#l00282">core_arena.c:282</a></div></div>
<div class="ttc" id="aa00015_html_ga39626941a835902709e5be48ab078b87"><div class="ttname"><a href="a00015.html#ga39626941a835902709e5be48ab078b87">arenas_mem_mmapped_count</a></div><div class="ttdeci">static size_t * arenas_mem_mmapped_count</div><div class="ttdoc">&gt;Amount of ram mmapped per arena (&gt;128K).</div><div class="ttdef"><b>Definition:</b> <a href="a00008_source.html#l00283">core_arena.c:283</a></div></div>
<div class="ttc" id="aa00015_html_ga43a17f892ca9f175f4534e44ebc76fc1"><div class="ttname"><a href="a00015.html#ga43a17f892ca9f175f4534e44ebc76fc1">arenas_mem_malloced_count</a></div><div class="ttdeci">static size_t * arenas_mem_malloced_count</div><div class="ttdoc">&gt;Amount of ram allocated per arena.</div><div class="ttdef"><b>Definition:</b> <a href="a00008_source.html#l00281">core_arena.c:281</a></div></div>
<div class="ttc" id="aa00015_html_ga49ca11b978773e49b190c6f977122988"><div class="ttname"><a href="a00015.html#ga49ca11b978773e49b190c6f977122988">arenas_mem_served</a></div><div class="ttdeci">static size_t * arenas_mem_served</div><div class="ttdoc">&gt;Number of mmapped ram per arena.</div><div class="ttdef"><b>Definition:</b> <a href="a00008_source.html#l00284">core_arena.c:284</a></div></div>
<div class="ttc" id="aa00015_html_ga55710d867b81d742af6057b89017ba7b"><div class="ttname"><a href="a00015.html#ga55710d867b81d742af6057b89017ba7b">LOG_CHUNK_MALLOCS</a></div><div class="ttdeci">#define LOG_CHUNK_MALLOCS</div><div class="ttdoc">Constant for logging allocations of memory for the arenas.</div><div class="ttdef"><b>Definition:</b> <a href="a00008_source.html#l00258">core_arena.c:258</a></div></div>
<div class="ttc" id="aa00015_html_ga5acb1eb15a723f350bda9bb29734b186"><div class="ttname"><a href="a00015.html#ga5acb1eb15a723f350bda9bb29734b186">arenas_mem_served_count</a></div><div class="ttdeci">static size_t * arenas_mem_served_count</div><div class="ttdoc">&gt;Amount of ram served through arena_alloc/calloc</div><div class="ttdef"><b>Definition:</b> <a href="a00008_source.html#l00285">core_arena.c:285</a></div></div>
<div class="ttc" id="aa00015_html_ga7f0e6ee371f41cbb641b2a74ffcc799e"><div class="ttname"><a href="a00015.html#ga7f0e6ee371f41cbb641b2a74ffcc799e">arenas_mem_malloced</a></div><div class="ttdeci">static size_t * arenas_mem_malloced</div><div class="ttdoc">&gt;Total usage in bytes.</div><div class="ttdef"><b>Definition:</b> <a href="a00008_source.html#l00280">core_arena.c:280</a></div></div>
<div class="ttc" id="aa00015_html_ga93bdbec87512dff3ba3a0c59de956149"><div class="ttname"><a href="a00015.html#ga93bdbec87512dff3ba3a0c59de956149">arenas_avg_mem_request</a></div><div class="ttdeci">static size_t * arenas_avg_mem_request</div><div class="ttdoc">‍For logging smallest memory request for each arena.</div><div class="ttdef"><b>Definition:</b> <a href="a00008_source.html#l00291">core_arena.c:291</a></div></div>
<div class="ttc" id="aa00015_html_ga9fd032f6aaa6a58f211f912303012499"><div class="ttname"><a href="a00015.html#ga9fd032f6aaa6a58f211f912303012499">arenas_max_chunk_size</a></div><div class="ttdeci">static size_t * arenas_max_chunk_size</div><div class="ttdoc">&gt;Number of servings of ram per arena.</div><div class="ttdef"><b>Definition:</b> <a href="a00008_source.html#l00287">core_arena.c:287</a></div></div>
<div class="ttc" id="aa00015_html_gab1eaae997e785328330ae4bbf7cf3d0f"><div class="ttname"><a href="a00015.html#gab1eaae997e785328330ae4bbf7cf3d0f">core_arena_log_level</a></div><div class="ttdeci">int16_t core_arena_log_level</div><div class="ttdoc">Defines our current log level, if compiled in.</div><div class="ttdef"><b>Definition:</b> <a href="a00008_source.html#l00262">core_arena.c:262</a></div></div>
<div class="ttc" id="aa00015_html_gad9e78bad28be8f331191b4603736f033"><div class="ttname"><a href="a00015.html#gad9e78bad28be8f331191b4603736f033">arenas_max_mem_request</a></div><div class="ttdeci">static size_t * arenas_max_mem_request</div><div class="ttdoc">‍For logging max chunk size for each arena.</div><div class="ttdef"><b>Definition:</b> <a href="a00008_source.html#l00289">core_arena.c:289</a></div></div>
<div class="ttc" id="aa00016_html_ga3429f895d1651d326f1f51b33103cf93"><div class="ttname"><a href="a00016.html#ga3429f895d1651d326f1f51b33103cf93">alloc_emsg2</a></div><div class="ttdeci">static const char * alloc_emsg2</div><div class="ttdef"><b>Definition:</b> <a href="a00008_source.html#l00398">core_arena.c:398</a></div></div>
<div class="ttc" id="aa00016_html_gaa9a9dfd169f61203f384a34ec9134241"><div class="ttname"><a href="a00016.html#gaa9a9dfd169f61203f384a34ec9134241">alloc_emsg3</a></div><div class="ttdeci">static const char * alloc_emsg3</div><div class="ttdef"><b>Definition:</b> <a href="a00008_source.html#l00400">core_arena.c:400</a></div></div>
<div class="ttc" id="aa00024_html"><div class="ttname"><a href="a00024.html">arena</a></div><div class="ttdoc">Our struct for book keeping of the arena and its storage .</div><div class="ttdef"><b>Definition:</b> <a href="a00008_source.html#l00037">core_arena.c:37</a></div></div>
<div class="ttc" id="aa00024_html_a3f9b268a1aaf3b8a2823433aec29faf2"><div class="ttname"><a href="a00024.html#a3f9b268a1aaf3b8a2823433aec29faf2">arena::chunk_sz</a></div><div class="ttdeci">size_t chunk_sz</div><div class="ttdoc">The size of the buffer allocated internally to satisfy memory requests from.</div><div class="ttdef"><b>Definition:</b> <a href="a00008_source.html#l00039">core_arena.c:39</a></div></div>
<div class="ttc" id="aa00024_html_ae6dcf9e039a3695a6fa348e704b5ab67"><div class="ttname"><a href="a00024.html#ae6dcf9e039a3695a6fa348e704b5ab67">arena::end</a></div><div class="ttdeci">char * end</div><div class="ttdoc">Address of one past end of buffer.</div><div class="ttdef"><b>Definition:</b> <a href="a00008_source.html#l00043">core_arena.c:43</a></div></div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="a00008_source.html#l00398">alloc_emsg2</a>, <a class="el" href="a00008_source.html#l00400">alloc_emsg3</a>, <a class="el" href="a00008_source.html#l00055">ARENA_HEADER_SIZE</a>, <a class="el" href="a00008_source.html#l00291">arenas_avg_mem_request</a>, <a class="el" href="a00008_source.html#l00183">ARENAS_MAX_ALLOC</a>, <a class="el" href="a00008_source.html#l00287">arenas_max_chunk_size</a>, <a class="el" href="a00008_source.html#l00289">arenas_max_mem_request</a>, <a class="el" href="a00008_source.html#l00280">arenas_mem_malloced</a>, <a class="el" href="a00008_source.html#l00281">arenas_mem_malloced_count</a>, <a class="el" href="a00008_source.html#l00282">arenas_mem_mmapped</a>, <a class="el" href="a00008_source.html#l00283">arenas_mem_mmapped_count</a>, <a class="el" href="a00008_source.html#l00284">arenas_mem_served</a>, <a class="el" href="a00008_source.html#l00285">arenas_mem_served_count</a>, <a class="el" href="a00008_source.html#l00290">arenas_min_mem_request</a>, <a class="el" href="a00008_source.html#l00033">c128K</a>, <a class="el" href="a00008_source.html#l00039">arena::chunk_sz</a>, <a class="el" href="a00008_source.html#l00262">core_arena_log_level</a>, <a class="el" href="a00008_source.html#l00043">arena::end</a>, <a class="el" href="a00008_source.html#l00048">first</a>, <a class="el" href="a00008_source.html#l00259">FULL_ARENA_LOGGING</a>, <a class="el" href="a00008_source.html#l00258">LOG_CHUNK_MALLOCS</a>, <a class="el" href="a00008_source.html#l00058">MAX</a>, <a class="el" href="a00005_source.html#l00049">MAX_ALIGN</a>, and <a class="el" href="a00008_source.html#l00279">tot_mem_usage</a>.</p>

<p class="reference">Referenced by <a class="el" href="a00008_source.html#l00847">arena_alloc()</a>.</p>

</div>
</div>
<a id="ga5289ecd9e87b60489a92476dff6db1f4" name="ga5289ecd9e87b60489a92476dff6db1f4"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga5289ecd9e87b60489a92476dff6db1f4">&#9670;&nbsp;</a></span>_arena_init()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static <a class="el" href="a00012.html#gaa3c04ba804275765a4e49c9872d46a25">Arena</a> * _arena_init </td>
          <td>(</td>
          <td class="paramtype">size_t&#160;</td>
          <td class="paramname"><em>n</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">size_t&#160;</td>
          <td class="paramname"><em>chunk_sz</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Initializes an arena and configures it with the effective chunk_size, and allocates the memory, with malloc(), it also accounts for memory allocated if logging is turned on. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">n</td><td>The arena numberer we arena initializing. </td></tr>
    <tr><td class="paramname">chunk_sz</td><td>MALLOC_BLOCKSZ_FIELD bytes larger than effective chunk size in bytes.</td></tr>
  </table>
  </dd>
</dl>
<p>We consider how malloc operates carefully to optimize block sizes and thereby improves efficiency of the heap.</p><ul>
<li>The amount of memory that malloc needs to store a pointer in the block is subtracted from the requested memory.</li>
<li>We do this, so that it is easy to use block sizes the size of page size (4096), whole multiples of that, or whole parts of that, (2048, 1024, 512, 256, 128, 64.). This makes it faster to allocate blocks, and if malloc needs to split blocks delivered from the heap, then the heap is kept as tidy as posible.</li>
<li>I recommend the smallest chunk_sz requested to be 1024 bytes. </li>
</ul>
<dl class="todo"><dt><b><a class="el" href="a00011.html#_todo000001">Todo:</a></b></dt><dd>: Not sure about this at all. But it is to be able to really get pages </dd></dl>
<dl class="todo"><dt><b><a class="el" href="a00011.html#_todo000002">Todo:</a></b></dt><dd></dd></dl>
<dl class="todo"><dt><b><a class="el" href="a00011.html#_todo000003">Todo:</a></b></dt><dd>: document this. </dd></dl>
<dl class="todo"><dt><b><a class="el" href="a00011.html#_todo000004">Todo:</a></b></dt><dd>: MALLOC_PTR_SIZE -&gt; MALLOC_BLOCKSZ_FIELD. (renaming) </dd></dl>

<p class="definition">Definition at line <a class="el" href="a00008_source.html#l00420">420</a> of file <a class="el" href="a00008_source.html">core_arena.c</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">  421</span>{</div>
<div class="line"><span class="lineno">  422</span>    ptrdiff_t chunk_pd = chunk_sz; <span class="comment">// maybe someone without gcc wants to compile it.</span></div>
<div class="line"><span class="lineno">  423</span> </div>
<div class="line"><span class="lineno">  424</span>    <span class="keywordflow">if</span> ( chunk_pd &lt;  <a class="code hl_define" href="a00005.html#afbb7b95d13f68d8d64cebb5bd2ca256e">MALLOC_BLOCKSZ_FIELD</a> + <a class="code hl_define" href="a00005.html#a545f62359724046a1928aba877fcf1f3">MAX_ALIGN</a> ) {</div>
<div class="line"><span class="lineno">  425</span>        fprintf( stderr, <a class="code hl_variable" href="a00016.html#gaed14729b276ffd787a796f3930aee5a0">alloc_emsg</a>,<span class="stringliteral">&quot;_arena_init&quot;</span>,n, chunk_sz );</div>
<div class="line"><span class="lineno">  426</span>        abort(  );</div>
<div class="line"><span class="lineno">  427</span>    }</div>
<div class="line"><span class="lineno">  428</span>    chunk_pd -= <a class="code hl_define" href="a00005.html#afbb7b95d13f68d8d64cebb5bd2ca256e">MALLOC_BLOCKSZ_FIELD</a>;</div>
<div class="line"><span class="lineno">  429</span> </div>
<div class="line"><span class="lineno">  432</span>    <span class="comment">// the size of 1024, but I think malloc will add 8 to 1024.</span></div>
<div class="line"><span class="lineno">  433</span>    <span class="comment">// so for instance the smart size to ask for is 4096-8 == 4088. </span></div>
<div class="line"><span class="lineno">  434</span> </div>
<div class="line"><span class="lineno">  435</span>   <span class="comment">// the size of the pointer malloc uses to address the allocated block.</span></div>
<div class="line"><span class="lineno">  436</span>    ptrdiff_t padding = -chunk_pd &amp; ( <a class="code hl_define" href="a00005.html#a545f62359724046a1928aba877fcf1f3">MAX_ALIGN</a> - 1 );</div>
<div class="line"><span class="lineno">  437</span> </div>
<div class="line"><span class="lineno">  438</span>    <span class="keywordflow">if</span> ( padding ) {</div>
<div class="line"><span class="lineno">  439</span>        chunk_pd -= ( <a class="code hl_define" href="a00005.html#a545f62359724046a1928aba877fcf1f3">MAX_ALIGN</a> - padding ); <span class="comment">// Guaranteed to be positive.</span></div>
<div class="line"><span class="lineno">  440</span>    }</div>
<div class="line"><span class="lineno">  441</span> </div>
<div class="line"><span class="lineno">  442</span>    <span class="keywordflow">if</span> ( chunk_pd &lt;= ( ptrdiff_t ) <a class="code hl_variable" href="a00012.html#ga2db21cb8e8ff4fdaa008145917a13c01">ARENA_HEADER_SIZE</a> ) {</div>
<div class="line"><span class="lineno">  443</span>        fprintf( stderr, <a class="code hl_variable" href="a00016.html#gaed14729b276ffd787a796f3930aee5a0">alloc_emsg</a>,<span class="stringliteral">&quot;_arena_init&quot;</span>,n, ( chunk_pd + padding + <a class="code hl_define" href="a00005.html#afbb7b95d13f68d8d64cebb5bd2ca256e">MALLOC_BLOCKSZ_FIELD</a> ) );</div>
<div class="line"><span class="lineno">  445</span>        exit(EXIT_FAILURE) ;</div>
<div class="line"><span class="lineno">  446</span>    }</div>
<div class="line"><span class="lineno">  447</span> </div>
<div class="line"><span class="lineno">  448</span>    <span class="keywordflow">if</span> ( chunk_pd &gt; (ssize_t) (<a class="code hl_variable" href="a00008.html#a8947d7bceb80934a62e9b068cdc31590">ARENAS_MAX_ALLOC</a> - <a class="code hl_define" href="a00005.html#afbb7b95d13f68d8d64cebb5bd2ca256e">MALLOC_BLOCKSZ_FIELD</a>) ) {</div>
<div class="line"><span class="lineno">  449</span>        fprintf( stderr, <a class="code hl_variable" href="a00016.html#ga3429f895d1651d326f1f51b33103cf93">alloc_emsg2</a>, <span class="stringliteral">&quot;_arena_init&quot;</span>,n, chunk_pd, <a class="code hl_variable" href="a00008.html#a8947d7bceb80934a62e9b068cdc31590">ARENAS_MAX_ALLOC</a> );</div>
<div class="line"><span class="lineno">  450</span>        exit(EXIT_FAILURE) ;</div>
<div class="line"><span class="lineno">  451</span>    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <a class="code hl_variable" href="a00015.html#ga1df927675e1c3b3474a43682105fe225">tot_mem_usage</a> &gt; <a class="code hl_variable" href="a00008.html#a8947d7bceb80934a62e9b068cdc31590">ARENAS_MAX_ALLOC</a> - (chunk_pd + <a class="code hl_define" href="a00005.html#afbb7b95d13f68d8d64cebb5bd2ca256e">MALLOC_BLOCKSZ_FIELD</a>) ) {</div>
<div class="line"><span class="lineno">  452</span>        fprintf( stderr, <a class="code hl_variable" href="a00016.html#gaa9a9dfd169f61203f384a34ec9134241">alloc_emsg3</a>, <span class="stringliteral">&quot;_arena_init&quot;</span>,n,chunk_pd, <a class="code hl_variable" href="a00008.html#a8947d7bceb80934a62e9b068cdc31590">ARENAS_MAX_ALLOC</a> );</div>
<div class="line"><span class="lineno">  453</span>        exit(EXIT_FAILURE) ;</div>
<div class="line"><span class="lineno">  454</span>    }</div>
<div class="line"><span class="lineno">  455</span> </div>
<div class="line"><span class="lineno">  456</span>    <a class="code hl_struct" href="a00024.html">Arena</a> *p;</div>
<div class="line"><span class="lineno">  457</span>    p = malloc( chunk_pd );</div>
<div class="line"><span class="lineno">  458</span>    <span class="keywordflow">if</span> ( !p ) {</div>
<div class="line"><span class="lineno">  459</span>        <span class="keywordflow">return</span> NULL;</div>
<div class="line"><span class="lineno">  460</span>    } </div>
<div class="line"><span class="lineno">  461</span>    <a class="code hl_variable" href="a00015.html#ga1df927675e1c3b3474a43682105fe225">tot_mem_usage</a> += chunk_pd ; <span class="comment">// updates total allocated.</span></div>
<div class="line"><span class="lineno">  462</span><span class="preprocessor">#ifndef CORE_ARENA_NO_LOGGING</span></div>
<div class="line"><span class="lineno">  463</span>    <span class="keywordflow">if</span> (<a class="code hl_variable" href="a00015.html#gab1eaae997e785328330ae4bbf7cf3d0f">core_arena_log_level</a> &gt;= <a class="code hl_define" href="a00015.html#ga55710d867b81d742af6057b89017ba7b">LOG_CHUNK_MALLOCS</a>  ) {</div>
<div class="line"><span class="lineno">  464</span>        <span class="keywordflow">if</span> ( chunk_pd &lt; <a class="code hl_variable" href="a00012.html#ga7523792ea5e325a82e80efcea1ef3791">c128K</a> ) {</div>
<div class="line"><span class="lineno">  465</span>            <a class="code hl_variable" href="a00015.html#ga7f0e6ee371f41cbb641b2a74ffcc799e">arenas_mem_malloced</a>[n] += chunk_pd ;</div>
<div class="line"><span class="lineno">  466</span>            <a class="code hl_variable" href="a00015.html#ga43a17f892ca9f175f4534e44ebc76fc1">arenas_mem_malloced_count</a>[n] += 1 ;</div>
<div class="line"><span class="lineno">  467</span>        } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno">  468</span>            <a class="code hl_variable" href="a00015.html#ga28ecc87bc4223b8f9c40e9bd2cf7ed32">arenas_mem_mmapped</a>[n] += chunk_pd ;</div>
<div class="line"><span class="lineno">  469</span>            <a class="code hl_variable" href="a00015.html#ga39626941a835902709e5be48ab078b87">arenas_mem_mmapped_count</a>[n] += 1 ;</div>
<div class="line"><span class="lineno">  470</span>        }</div>
<div class="line"><span class="lineno">  471</span>        <a class="code hl_variable" href="a00015.html#ga9fd032f6aaa6a58f211f912303012499">arenas_max_chunk_size</a>[n] = chunk_pd ;</div>
<div class="line"><span class="lineno">  472</span>    }</div>
<div class="line"><span class="lineno">  473</span><span class="preprocessor">#endif</span></div>
<div class="line"><span class="lineno">  474</span>    p-&gt;<a class="code hl_variable" href="a00024.html#a3f9b268a1aaf3b8a2823433aec29faf2">chunk_sz</a> = chunk_pd;</div>
<div class="line"><span class="lineno">  475</span>    p-&gt;<a class="code hl_variable" href="a00024.html#ac5bb4f79f00e8009508d13bc99ff029b">begin</a> = ( <span class="keywordtype">char</span> * ) p + <a class="code hl_variable" href="a00012.html#ga2db21cb8e8ff4fdaa008145917a13c01">ARENA_HEADER_SIZE</a>;</div>
<div class="line"><span class="lineno">  476</span>    p-&gt;<a class="code hl_variable" href="a00024.html#ae6dcf9e039a3695a6fa348e704b5ab67">end</a> = ( <span class="keywordtype">char</span> * ) p + chunk_pd; <span class="comment">// real_size;</span></div>
<div class="line"><span class="lineno">  477</span>    p-&gt;<a class="code hl_variable" href="a00024.html#a0de814d9e57c6c391825e99598bf45a6">next</a> = NULL;</div>
<div class="line"><span class="lineno">  478</span>   <span class="comment">// see https://nullprogram.com/blog/2023/09/27/ (the alloca() function //</span></div>
<div class="line"><span class="lineno">  479</span>    <span class="keywordflow">return</span> p;</div>
<div class="line"><span class="lineno">  480</span>}</div>
<div class="ttc" id="aa00005_html_afbb7b95d13f68d8d64cebb5bd2ca256e"><div class="ttname"><a href="a00005.html#afbb7b95d13f68d8d64cebb5bd2ca256e">MALLOC_BLOCKSZ_FIELD</a></div><div class="ttdeci">#define MALLOC_BLOCKSZ_FIELD</div><div class="ttdoc">The size of the pointer malloc needs into the memory block, probably same as WORD_SIZE.</div><div class="ttdef"><b>Definition:</b> <a href="a00005_source.html#l00053">core_arena.h:53</a></div></div>
<div class="ttc" id="aa00016_html_gaed14729b276ffd787a796f3930aee5a0"><div class="ttname"><a href="a00016.html#gaed14729b276ffd787a796f3930aee5a0">alloc_emsg</a></div><div class="ttdeci">static const char * alloc_emsg</div><div class="ttdef"><b>Definition:</b> <a href="a00008_source.html#l00397">core_arena.c:397</a></div></div>
<div class="ttc" id="aa00024_html_a0de814d9e57c6c391825e99598bf45a6"><div class="ttname"><a href="a00024.html#a0de814d9e57c6c391825e99598bf45a6">arena::next</a></div><div class="ttdeci">struct arena * next</div><div class="ttdoc">Link to next arena, one arena can consist of manyy arenas backed by individual buffers.</div><div class="ttdef"><b>Definition:</b> <a href="a00008_source.html#l00038">core_arena.c:38</a></div></div>
<div class="ttc" id="aa00024_html_ac5bb4f79f00e8009508d13bc99ff029b"><div class="ttname"><a href="a00024.html#ac5bb4f79f00e8009508d13bc99ff029b">arena::begin</a></div><div class="ttdeci">char * begin</div><div class="ttdoc">Next available location in the internal buffer to allocate memory from.</div><div class="ttdef"><b>Definition:</b> <a href="a00008_source.html#l00040">core_arena.c:40</a></div></div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="a00008_source.html#l00397">alloc_emsg</a>, <a class="el" href="a00008_source.html#l00398">alloc_emsg2</a>, <a class="el" href="a00008_source.html#l00400">alloc_emsg3</a>, <a class="el" href="a00008_source.html#l00055">ARENA_HEADER_SIZE</a>, <a class="el" href="a00008_source.html#l00183">ARENAS_MAX_ALLOC</a>, <a class="el" href="a00008_source.html#l00287">arenas_max_chunk_size</a>, <a class="el" href="a00008_source.html#l00280">arenas_mem_malloced</a>, <a class="el" href="a00008_source.html#l00281">arenas_mem_malloced_count</a>, <a class="el" href="a00008_source.html#l00282">arenas_mem_mmapped</a>, <a class="el" href="a00008_source.html#l00283">arenas_mem_mmapped_count</a>, <a class="el" href="a00008_source.html#l00040">arena::begin</a>, <a class="el" href="a00008_source.html#l00033">c128K</a>, <a class="el" href="a00008_source.html#l00039">arena::chunk_sz</a>, <a class="el" href="a00008_source.html#l00262">core_arena_log_level</a>, <a class="el" href="a00008_source.html#l00043">arena::end</a>, <a class="el" href="a00008_source.html#l00258">LOG_CHUNK_MALLOCS</a>, <a class="el" href="a00005_source.html#l00053">MALLOC_BLOCKSZ_FIELD</a>, <a class="el" href="a00005_source.html#l00049">MAX_ALIGN</a>, <a class="el" href="a00008_source.html#l00038">arena::next</a>, and <a class="el" href="a00008_source.html#l00279">tot_mem_usage</a>.</p>

<p class="reference">Referenced by <a class="el" href="a00008_source.html#l01007">arena_create()</a>.</p>

</div>
</div>
<h2 class="groupheader">Variable Documentation</h2>
<a id="gaed14729b276ffd787a796f3930aee5a0" name="gaed14729b276ffd787a796f3930aee5a0"></a>
<h2 class="memtitle"><span class="permalink"><a href="#gaed14729b276ffd787a796f3930aee5a0">&#9670;&nbsp;</a></span>alloc_emsg</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">const char* alloc_emsg = &quot;%s: <a class="el" href="a00024.html">arena</a>[%u] The chunk_sz requested is to small: %d\n&quot;</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="a00008_source.html#l00397">397</a> of file <a class="el" href="a00008_source.html">core_arena.c</a>.</p>

<p class="reference">Referenced by <a class="el" href="a00008_source.html#l00420">_arena_init()</a>.</p>

</div>
</div>
<a id="ga3429f895d1651d326f1f51b33103cf93" name="ga3429f895d1651d326f1f51b33103cf93"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga3429f895d1651d326f1f51b33103cf93">&#9670;&nbsp;</a></span>alloc_emsg2</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">const char* alloc_emsg2</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<b>Initial value:</b><div class="fragment"><div class="line">= <span class="stringliteral">&quot;%s: arena[%u] The chunk_sz: %lu requested is too large.\n&quot;</span></div>
<div class="line">                           <span class="stringliteral">&quot;The request is larger than ARENAS_MAX_ALLOC %lu: &quot;</span></div>
</div><!-- fragment -->
<p class="definition">Definition at line <a class="el" href="a00008_source.html#l00398">398</a> of file <a class="el" href="a00008_source.html">core_arena.c</a>.</p>

<p class="reference">Referenced by <a class="el" href="a00008_source.html#l00500">_alloc()</a>, and <a class="el" href="a00008_source.html#l00420">_arena_init()</a>.</p>

</div>
</div>
<a id="gaa9a9dfd169f61203f384a34ec9134241" name="gaa9a9dfd169f61203f384a34ec9134241"></a>
<h2 class="memtitle"><span class="permalink"><a href="#gaa9a9dfd169f61203f384a34ec9134241">&#9670;&nbsp;</a></span>alloc_emsg3</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">const char* alloc_emsg3</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<b>Initial value:</b><div class="fragment"><div class="line">= <span class="stringliteral">&quot;%s: arena[%u] The chunk_sz: %lu requested is too large.\n&quot;</span></div>
<div class="line">                           <span class="stringliteral">&quot;It will make the total number of bytes requested larger than ARENAS_MAX_ALLOC %lu: &quot;</span></div>
</div><!-- fragment -->
<p class="definition">Definition at line <a class="el" href="a00008_source.html#l00400">400</a> of file <a class="el" href="a00008_source.html">core_arena.c</a>.</p>

<p class="reference">Referenced by <a class="el" href="a00008_source.html#l00500">_alloc()</a>, and <a class="el" href="a00008_source.html#l00420">_arena_init()</a>.</p>

</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Mon Feb 26 2024 17:02:45 for core_arena by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.4
</small></address>
</body>
</html>
